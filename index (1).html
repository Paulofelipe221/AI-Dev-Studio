<!DOCTYPE html>
<html lang="pt-br">
<head>
<script>
/*! coi-serviceworker v0.1.7 - Guido Zuidhof and contributors, licensed under MIT */
let coepCredentialless = false;
if (typeof window === 'undefined') {
    self.addEventListener("install", () => self.skipWaiting());
    self.addEventListener("activate", (event) => event.waitUntil(self.clients.claim()));

    self.addEventListener("message", (ev) => {
        if (!ev.data) {
            return;
        } else if (ev.data.type === "deregister") {
            self.registration
                .unregister()
                .then(() => {
                    return self.clients.matchAll();
                })
                .then(clients => {
                    clients.forEach((client) => client.navigate(client.url));
                });
        } else if (ev.data.type === "coepCredentialless") {
            coepCredentialless = ev.data.value;
        }
    });

    self.addEventListener("fetch", function (event) {
        const r = event.request;
        if (r.cache === "only-if-cached" && r.mode !== "same-origin") {
            return;
        }

        const request = (coepCredentialless && r.mode === "no-cors")
            ? new Request(r, {
                credentials: "omit",
            })
            : r;
        event.respondWith(
            fetch(request)
                .then((response) => {
                    if (response.status === 0) {
                        return response;
                    }

                    const newHeaders = new Headers(response.headers);
                    newHeaders.set("Cross-Origin-Embedder-Policy",
                        coepCredentialless ? "credentialless" : "require-corp"
                    );
                    if (!coepCredentialless) {
                        newHeaders.set("Cross-Origin-Resource-Policy", "cross-origin");
                    }
                    newHeaders.set("Cross-Origin-Opener-Policy", "same-origin");

                    return new Response(response.body, {
                        status: response.status,
                        statusText: response.statusText,
                        headers: newHeaders,
                    });
                })
                .catch((e) => console.error(e))
        );
    });

} else {
    (() => {
        const reloadedBySelf = window.sessionStorage.getItem("coiReloadedBySelf");
        window.sessionStorage.removeItem("coiReloadedBySelf");
        const coepDegrading = (reloadedBySelf == "coepdegrade");

        // You can customize the behavior of this script through a global `coi` variable.
        const coi = {
            shouldRegister: () => !reloadedBySelf,
            shouldDeregister: () => false,
            coepCredentialless: () => true,
            coepDegrade: () => true,
            doReload: () => window.location.reload(),
            quiet: false,
            ...window.coi
        };

        const n = navigator;
        const controlling = n.serviceWorker && n.serviceWorker.controller;

        // Record the failure if the page is served by serviceWorker.
        if (controlling && !window.crossOriginIsolated) {
            window.sessionStorage.setItem("coiCoepHasFailed", "true");
        }
        const coepHasFailed = window.sessionStorage.getItem("coiCoepHasFailed");

        if (controlling) {
            // Reload only on the first failure.
            const reloadToDegrade = coi.coepDegrade() && !(
                coepDegrading || window.crossOriginIsolated
            );
            n.serviceWorker.controller.postMessage({
                type: "coepCredentialless",
                value: (reloadToDegrade || coepHasFailed && coi.coepDegrade())
                    ? false
                    : coi.coepCredentialless(),
            });
            if (reloadToDegrade) {
                !coi.quiet && console.log("Reloading page to degrade COEP.");
                window.sessionStorage.setItem("coiReloadedBySelf", "coepdegrade");
                coi.doReload("coepdegrade");
            }

            if (coi.shouldDeregister()) {
                n.serviceWorker.controller.postMessage({ type: "deregister" });
            }
        }

        // If we're already coi: do nothing. Perhaps it's due to this script doing its job, or COOP/COEP are
        // already set from the origin server. Also if the browser has no notion of crossOriginIsolated, just give up here.
        if (window.crossOriginIsolated !== false || !coi.shouldRegister()) return;

        if (!window.isSecureContext) {
            !coi.quiet && console.log("COOP/COEP Service Worker not registered, a secure context is required.");
            return;
        }

        // In some environments (e.g. Firefox private mode) this won't be available
        if (!n.serviceWorker) {
            !coi.quiet && console.error("COOP/COEP Service Worker not registered, perhaps due to private mode.");
            return;
        }

        n.serviceWorker.register(window.document.currentScript.src).then(
            (registration) => {
                !coi.quiet && console.log("COOP/COEP Service Worker registered", registration.scope);

                registration.addEventListener("updatefound", () => {
                    !coi.quiet && console.log("Reloading page to make use of updated COOP/COEP Service Worker.");
                    window.sessionStorage.setItem("coiReloadedBySelf", "updatefound");
                    coi.doReload();
                });

                // If the registration is active, but it's not controlling the page
                if (registration.active && !n.serviceWorker.controller) {
                    !coi.quiet && console.log("Reloading page to make use of COOP/COEP Service Worker.");
                    window.sessionStorage.setItem("coiReloadedBySelf", "notcontrolling");
                    coi.doReload();
                }
            },
            (err) => {
                !coi.quiet && console.error("COOP/COEP Service Worker failed to register:", err);
            }
        );
    })();
}
</script>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,interactive-widget=resizes-content"/>
<meta name="theme-color" content="#0a0a0f"/>
<meta name="mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<title>CodeMind AI | Local Engine</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet"/>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
:root{
  --bg:#08080e;--s1:#0f0f18;--s2:#14141f;--s3:#1a1a28;
  --b1:#222235;--b2:#323250;
  --ac:#7c3aed;--acl:#a78bfa;--acg:rgba(124,58,237,.18);
  --cy:#22d3ee;--gr:#22c55e;--rd:#f43f5e;--yw:#fbbf24;--or:#f97316;
  --t1:#eeeeff;--t2:#8080a8;--t3:#3d3d5c;
}
html{height:100%;height:-webkit-fill-available;}
body{
  background:var(--bg);color:var(--t1);font-family:'Inter',sans-serif;
  display:flex;flex-direction:column;
  height:100vh;height:100dvh;
  overflow:hidden;-webkit-text-size-adjust:100%;
}
::-webkit-scrollbar{width:3px;height:3px;}
::-webkit-scrollbar-thumb{background:var(--b2);border-radius:3px;}

/* â”€â”€â”€ HEADER â”€â”€â”€ */
.hdr{display:flex;align-items:center;gap:10px;padding:10px 14px;background:var(--s1);border-bottom:1px solid var(--b1);flex-shrink:0;z-index:50;}
.ham{width:34px;height:34px;border-radius:8px;background:var(--s3);border:1px solid var(--b1);display:grid;place-items:center;cursor:pointer;font-size:16px;color:var(--t2);flex-shrink:0;-webkit-tap-highlight-color:transparent;}
.logo{display:flex;align-items:center;gap:8px;}
.lmark{width:30px;height:30px;border-radius:8px;flex-shrink:0;background:linear-gradient(135deg,var(--ac),var(--cy));display:grid;place-items:center;font-size:10px;font-weight:900;color:#fff;}
.lname{font-size:15px;font-weight:700;}
.lname em{color:var(--acl);font-style:normal;}
.lbadge{font-size:9px;padding:2px 6px;border-radius:20px;background:linear-gradient(135deg,var(--ac),var(--cy));color:#fff;font-weight:700;}
.hright{margin-left:auto;display:flex;align-items:center;gap:8px;}
.pill{display:flex;align-items:center;gap:5px;padding:5px 10px;border-radius:20px;background:var(--s3);border:1px solid var(--b1);font-size:11px;color:var(--t2);cursor:pointer;-webkit-tap-highlight-color:transparent;}
.sdot{width:7px;height:7px;border-radius:50%;background:var(--t3);flex-shrink:0;transition:.3s;}
.sdot.loading{background:var(--yw);animation:pulse 1s infinite;}
.sdot.on{background:var(--gr);box-shadow:0 0 6px var(--gr);}
.sdot.err{background:var(--rd);}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}

/* â”€â”€â”€ AI LOAD OVERLAY â”€â”€â”€ */
#aiOverlay{
  position:fixed;inset:0;background:rgba(8,8,14,.95);z-index:9999;
  display:flex;flex-direction:column;align-items:center;justify-content:center;gap:20px;
  backdrop-filter:blur(8px);
}
#aiOverlay.hidden{display:none;}
.ol-logo{width:60px;height:60px;border-radius:16px;background:linear-gradient(135deg,var(--ac),var(--cy));display:grid;place-items:center;font-size:24px;animation:glow 2s infinite;}
@keyframes glow{0%,100%{box-shadow:0 0 20px rgba(124,58,237,.4)}50%{box-shadow:0 0 40px rgba(124,58,237,.8)}}
.ol-title{font-size:22px;font-weight:700;text-align:center;}
.ol-title em{color:var(--acl);font-style:normal;}
.ol-sub{font-size:13px;color:var(--t2);text-align:center;max-width:320px;line-height:1.6;}
.ol-bar-wrap{width:280px;height:6px;background:var(--s3);border-radius:6px;overflow:hidden;}
.ol-bar{height:100%;width:0%;background:linear-gradient(90deg,var(--ac),var(--cy));border-radius:6px;transition:width .3s;}
.ol-status{font-size:12px;color:var(--t3);text-align:center;min-height:18px;font-family:'JetBrains Mono',monospace;}
.ol-skip{margin-top:8px;padding:8px 20px;border-radius:8px;background:var(--s3);border:1px solid var(--b1);color:var(--t2);font-size:13px;cursor:pointer;font-family:'Inter',sans-serif;}
.ol-skip:hover{border-color:var(--ac);color:var(--acl);}

/* â”€â”€â”€ ENGINE SELECTOR â”€â”€â”€ */
.engine-toggle{display:flex;gap:4px;padding:10px 12px;border-bottom:1px solid var(--b1);}
.etog{flex:1;padding:7px;border-radius:7px;font-size:11px;font-weight:600;border:1px solid var(--b1);background:var(--s2);color:var(--t2);cursor:pointer;font-family:'Inter',sans-serif;text-align:center;-webkit-tap-highlight-color:transparent;}
.etog.on{background:var(--acg);border-color:var(--ac);color:var(--acl);}

/* â”€â”€â”€ OVERLAY + DRAWER â”€â”€â”€ */
.ov{display:none;position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:200;backdrop-filter:blur(4px);}
.ov.show{display:block;}
.drawer{position:fixed;left:0;top:0;bottom:0;width:290px;background:var(--s1);border-right:1px solid var(--b1);z-index:300;overflow-y:auto;transform:translateX(-100%);transition:transform .25s cubic-bezier(.4,0,.2,1);-webkit-overflow-scrolling:touch;}
.drawer.open{transform:translateX(0);}
.dh{display:flex;align-items:center;justify-content:space-between;padding:14px 14px 10px;border-bottom:1px solid var(--b1);}
.dh-title{font-size:12px;font-weight:700;color:var(--acl);text-transform:uppercase;letter-spacing:1px;}
.dh-x{width:28px;height:28px;border-radius:6px;border:1px solid var(--b1);background:var(--s3);color:var(--t2);cursor:pointer;display:grid;place-items:center;font-size:13px;-webkit-tap-highlight-color:transparent;}
.dsec{padding:12px 12px 6px;}
.dlbl{font-size:10px;font-weight:600;color:var(--t3);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;}
.kcard{background:var(--s3);border:1px solid var(--b1);border-radius:10px;padding:12px;margin-bottom:8px;}
.kcard label{font-size:11px;color:var(--t3);display:block;margin-bottom:5px;}
.kinp{width:100%;background:var(--bg);border:1px solid var(--b1);color:var(--t1);padding:8px 10px;border-radius:7px;font-family:'JetBrains Mono',monospace;font-size:11px;outline:none;}
.kinp:focus{border-color:var(--ac);}
.msel{width:100%;margin-top:8px;background:var(--bg);border:1px solid var(--b1);color:var(--t1);padding:7px 9px;border-radius:7px;font-family:'Inter',sans-serif;font-size:12px;outline:none;}
.ksave{width:100%;margin-top:8px;padding:9px;border-radius:7px;background:linear-gradient(135deg,var(--ac),#5b21b6);color:#fff;font-weight:700;font-size:13px;font-family:'Inter',sans-serif;border:none;cursor:pointer;-webkit-tap-highlight-color:transparent;}
.tlist{display:flex;flex-direction:column;gap:1px;}
.titem{display:flex;align-items:center;gap:9px;padding:10px;border-radius:8px;cursor:pointer;border:none;background:transparent;color:var(--t2);font-family:'Inter',sans-serif;font-size:13px;width:100%;text-align:left;-webkit-tap-highlight-color:transparent;}
.titem:active,.titem.on{background:rgba(124,58,237,.15);color:var(--acl);font-weight:500;}
.titem .ic{font-size:14px;width:20px;text-align:center;flex-shrink:0;}
.upzone{border:2px dashed var(--b2);border-radius:10px;padding:16px 12px;text-align:center;cursor:pointer;margin-top:4px;-webkit-tap-highlight-color:transparent;}
.upzone:active{border-color:var(--ac);background:var(--acg);}
.upzone p{font-size:11px;color:var(--t3);margin-top:4px;}
.fchip{display:flex;align-items:center;gap:6px;padding:6px 8px;background:var(--s3);border-radius:6px;font-size:11px;color:var(--t2);margin-top:4px;border:1px solid var(--b1);}
.fchip .fn{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.fchip .rm{color:var(--rd);cursor:pointer;opacity:.7;}
#fi{display:none;}

/* â”€â”€â”€ TABS â”€â”€â”€ */
.tabs{display:flex;background:var(--s1);border-bottom:1px solid var(--b1);flex-shrink:0;}
.tab{flex:1;padding:11px;font-size:13px;font-weight:500;background:none;border:none;color:var(--t3);cursor:pointer;border-bottom:2px solid transparent;font-family:'Inter',sans-serif;-webkit-tap-highlight-color:transparent;}
.tab.on{color:var(--acl);border-bottom-color:var(--ac);}
.views{display:flex;flex-direction:column;flex:1;overflow:hidden;min-height:0;}

/* â”€â”€â”€ CHAT â”€â”€â”€ */
#vC{display:flex;flex-direction:column;flex:1;overflow:hidden;min-height:0;}
.msgs{flex:1;overflow-y:auto;padding:12px;display:flex;flex-direction:column;gap:12px;min-height:0;-webkit-overflow-scrolling:touch;}
.msg{display:flex;gap:8px;animation:slideup .2s ease;}
@keyframes slideup{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:none}}
.msg.u{flex-direction:row-reverse;}
.msg.sc,.msg.er{justify-content:center;}
.av{width:28px;height:28px;border-radius:8px;flex-shrink:0;display:grid;place-items:center;font-size:12px;align-self:flex-start;margin-top:18px;}
.msg.ai .av{background:linear-gradient(135deg,var(--ac),var(--cy));}
.msg.u .av{background:var(--s3);border:1px solid var(--b1);}
.mw{flex:1;min-width:0;}
.mn{font-size:10px;font-weight:600;margin-bottom:3px;}
.msg.ai .mn{color:var(--acl);}
.msg.u .mn{color:var(--t3);text-align:right;}
.bub{padding:10px 13px;border-radius:12px;font-size:14px;line-height:1.7;word-break:break-word;}
.msg.ai .bub{background:var(--s2);border:1px solid var(--b1);border-radius:4px 12px 12px 12px;}
.msg.u .bub{background:var(--ac);border-radius:12px 4px 12px 12px;color:#fff;}
.msg.sc .bub{background:rgba(34,197,94,.07);border:1px solid rgba(34,197,94,.2);color:var(--gr);font-size:12px;text-align:center;border-radius:8px;max-width:88%;}
.msg.er .bub{background:rgba(244,63,94,.07);border:1px solid rgba(244,63,94,.2);color:var(--rd);font-size:13px;border-radius:10px;max-width:96%;}
.cbts{display:flex;gap:6px;flex-wrap:wrap;margin-top:10px;}
.cb{padding:5px 11px;border-radius:7px;font-size:12px;font-weight:500;border:1px solid var(--b1);background:var(--s3);color:var(--t2);cursor:pointer;font-family:'Inter',sans-serif;-webkit-tap-highlight-color:transparent;}
.cb:active{border-color:var(--ac);color:var(--acl);}
.cb.p{background:var(--ac);border-color:var(--ac);color:#fff;}
.streaming{display:inline-block;width:2px;height:14px;background:var(--acl);animation:blink .7s infinite;vertical-align:middle;margin-left:2px;}
@keyframes blink{0%,100%{opacity:1}50%{opacity:0}}
.typing{display:flex;align-items:center;gap:4px;padding:2px 0;}
.typing span{width:6px;height:6px;border-radius:50%;background:var(--t3);animation:b .8s infinite;}
.typing span:nth-child(2){animation-delay:.15s;}
.typing span:nth-child(3){animation-delay:.3s;}
@keyframes b{0%,100%{transform:translateY(0)}50%{transform:translateY(-5px)}}

/* â”€â”€â”€ BOTTOM â”€â”€â”€ */
.bot{flex-shrink:0;background:var(--s1);border-top:1px solid var(--b1);}
.sugs{display:flex;gap:6px;padding:8px 12px 6px;overflow-x:auto;-webkit-overflow-scrolling:touch;}
.sugs::-webkit-scrollbar{height:0;}
.sg{padding:6px 11px;border-radius:20px;font-size:12px;white-space:nowrap;background:var(--s3);border:1px solid var(--b1);color:var(--t2);cursor:pointer;flex-shrink:0;-webkit-tap-highlight-color:transparent;}
.sg:active{background:var(--acg);border-color:var(--ac);color:var(--acl);}
.mbar{display:flex;gap:5px;padding:0 12px 7px;overflow-x:auto;-webkit-overflow-scrolling:touch;}
.mbar::-webkit-scrollbar{height:0;}
.mc{padding:4px 9px;border-radius:6px;font-size:11px;font-weight:500;border:1px solid var(--b1);background:transparent;color:var(--t3);cursor:pointer;white-space:nowrap;font-family:'Inter',sans-serif;-webkit-tap-highlight-color:transparent;}
.mc.on{background:rgba(124,58,237,.2);border-color:var(--ac);color:var(--acl);}
.irow{display:flex;align-items:flex-end;gap:8px;background:var(--s3);border:1.5px solid var(--b1);border-radius:12px;padding:9px 10px;margin:0 12px;transition:.2s;}
.irow:focus-within{border-color:var(--ac);box-shadow:0 0 0 3px var(--acg);}
#inp{flex:1;background:none;border:none;color:var(--t1);font-family:'Inter',sans-serif;font-size:15px;resize:none;outline:none;max-height:120px;min-height:22px;line-height:1.5;-webkit-appearance:none;}
#inp::placeholder{color:var(--t3);}
.sbtn{width:36px;height:36px;border-radius:9px;background:linear-gradient(135deg,var(--ac),#5b21b6);border:none;cursor:pointer;display:grid;place-items:center;flex-shrink:0;-webkit-tap-highlight-color:transparent;}
.sbtn:active{transform:scale(.93);}
.sbtn:disabled{background:var(--b1);}
.sbtn svg{width:15px;height:15px;fill:#fff;}
.ipad{height:8px;}

/* â”€â”€â”€ EDITOR â”€â”€â”€ */
#vE{display:none;flex-direction:column;flex:1;overflow:hidden;min-height:0;}
.etb{display:flex;gap:5px;padding:8px 10px;background:var(--s1);border-bottom:1px solid var(--b1);flex-shrink:0;overflow-x:auto;-webkit-overflow-scrolling:touch;}
.etb::-webkit-scrollbar{height:0;}
.eb{padding:6px 11px;border-radius:7px;font-size:12px;font-weight:500;border:1px solid var(--b1);background:var(--s2);color:var(--t2);cursor:pointer;font-family:'Inter',sans-serif;white-space:nowrap;-webkit-tap-highlight-color:transparent;}
.eb:active{border-color:var(--ac);color:var(--acl);}
.eb.p{background:linear-gradient(135deg,var(--ac),#5b21b6);border-color:var(--ac);color:#fff;}
.epanes{display:flex;flex-direction:column;flex:1;overflow:hidden;min-height:0;}
@media(min-width:700px){.epanes{flex-direction:row;}}
.cpane,.ppane{display:flex;flex-direction:column;flex:1;overflow:hidden;min-height:0;}
.cpane{border-bottom:1px solid var(--b1);}
@media(min-width:700px){.cpane{border-bottom:none;border-right:1px solid var(--b1);}}
.pbar{display:flex;align-items:center;justify-content:space-between;padding:5px 12px;background:var(--s2);border-bottom:1px solid var(--b1);font-size:11px;color:var(--t3);flex-shrink:0;}
.pdots{display:flex;gap:4px;}
.pd{width:8px;height:8px;border-radius:50%;}
#ca{flex:1;padding:12px;background:var(--bg);color:#e0dfff;font-family:'JetBrains Mono',monospace;font-size:12px;line-height:1.7;border:none;resize:none;outline:none;overflow-y:auto;white-space:pre;tab-size:2;-webkit-overflow-scrolling:touch;}
#ca::placeholder{color:var(--t3);}
#pf{flex:1;width:100%;border:none;background:#fff;}

/* â”€â”€â”€ PROGRESS â”€â”€â”€ */
.prog{position:fixed;top:0;left:0;width:0;height:2px;background:linear-gradient(90deg,var(--ac),var(--cy));z-index:9999;transition:width .3s;}

/* â”€â”€â”€ TOAST â”€â”€â”€ */
#toast{position:fixed;bottom:18px;left:50%;transform:translateX(-50%) translateY(8px);background:var(--s3);border:1px solid var(--b1);color:var(--t1);padding:8px 16px;border-radius:8px;font-size:13px;opacity:0;transition:.22s;z-index:9999;pointer-events:none;white-space:nowrap;max-width:88vw;overflow:hidden;text-overflow:ellipsis;}
#toast.show{opacity:1;transform:translateX(-50%) translateY(0);}
#toast.ok{border-color:var(--gr);color:var(--gr);}
#toast.err{border-color:var(--rd);color:var(--rd);}

/* â”€â”€â”€ AUTO-HEAL BADGE â”€â”€â”€ */
.heal-badge{position:fixed;bottom:80px;right:14px;background:rgba(34,197,94,.15);border:1px solid rgba(34,197,94,.3);color:var(--gr);font-size:11px;padding:6px 10px;border-radius:8px;z-index:500;display:none;animation:slideup .3s ease;}
.heal-badge.show{display:block;}

/* Info card in drawer */
.info-card{background:rgba(34,197,94,.06);border:1px solid rgba(34,197,94,.2);border-radius:8px;padding:10px 11px;margin-bottom:8px;font-size:12px;color:#4ade80;line-height:1.6;}
.warn-card{background:rgba(251,191,36,.06);border:1px solid rgba(251,191,36,.2);border-radius:8px;padding:10px 11px;margin-bottom:8px;font-size:12px;color:#fbbf24;line-height:1.6;}
</style>
</head>
<body>

<!-- AI Loading Overlay -->
<div id="aiOverlay">
  <div class="ol-logo" id="olIcon">ğŸ§ </div>
  <div class="ol-title" id="olTitle">Code<em>Mind</em> AI</div>
  <div class="ol-sub" id="olSub">Carregando o motor de IA local...<br/>Isso leva ~30s na primeira vez. O modelo fica no cache depois.</div>
  <div class="ol-bar-wrap"><div class="ol-bar" id="olBar"></div></div>
  <div class="ol-status" id="olStatus">Iniciando WebGPU...</div>
  <button class="ol-skip" id="olRetryBtn" style="display:none;background:rgba(124,58,237,.2);border-color:var(--ac);color:var(--acl);" onclick="retryLocalEngine()">ğŸ”„ Tentar Novamente</button>
  <button class="ol-skip" id="olSkipBtn" onclick="skipToGemini()">â˜° Configurar Gemini API</button>
</div>

<div class="prog" id="prog"></div>
<div id="toast"></div>
<div class="heal-badge" id="healBadge">ğŸ”§ Auto-Heal ativado!</div>

<!-- DRAWER -->
<div class="ov" id="ov" onclick="dClose()"></div>
<aside class="drawer" id="dr">
  <div class="dh">
    <span class="dh-title">âš™ï¸ ConfiguraÃ§Ãµes</span>
    <button class="dh-x" onclick="dClose()">âœ•</button>
  </div>

  <!-- Engine Toggle -->
  <div style="padding:10px 12px 0">
    <div class="dlbl" style="margin-bottom:6px">ğŸ”Œ Motor de IA</div>
    <div style="display:flex;gap:4px;margin-bottom:10px;flex-wrap:wrap;">
      <button class="etog" id="engWasm" onclick="setEngine('wasm')" style="flex:1;background:rgba(34,211,238,.1);border-color:rgba(34,211,238,.3);color:#22d3ee;">ğŸ§© WASM (celular)</button>
      <button class="etog on" id="engLocal" onclick="setEngine('local')" style="flex:1;">ğŸ§  WebGPU (PC)</button>
      <button class="etog" id="engGemini" onclick="setEngine('gemini')" style="flex:1;">â˜ï¸ Gemini API</button>
    </div>

    <div id="wasmSection" style="display:none">
      <div class="info-card" style="border-color:rgba(34,211,238,.3);color:#22d3ee;background:rgba(34,211,238,.06);">
        ğŸ§© <strong>Modo WASM (recomendado para celular)</strong><br/>
        Usa CPU via WebAssembly. Funciona em <strong>qualquer Android</strong> sem precisar de WebGPU. Mais lento mas universal.
      </div>
      <div class="kcard">
        <label>ğŸ¤– Modelo WASM (GGUF)</label>
        <select class="msel" id="wasmMsel" onchange="changeWasmModel()">
          <option value="Qwen/Qwen2.5-0.5B-Instruct-GGUF|qwen2.5-0.5b-instruct-q4_k_m.gguf">âš¡ Qwen2.5 0.5B Q4 â€” ~400MB Â· mais rÃ¡pido</option>
          <option value="Qwen/Qwen2.5-Coder-1.5B-Instruct-GGUF|qwen2.5-coder-1.5b-instruct-q4_k_m.gguf">ğŸ’» Qwen Coder 1.5B Q4 â€” ~1GB Â· melhor cÃ³digo</option>
          <option value="bartowski/Llama-3.2-1B-Instruct-GGUF|Llama-3.2-1B-Instruct-Q4_K_M.gguf">ğŸ¦™ Llama 3.2 1B Q4 â€” ~700MB</option>
          <option value="ggml-org/gemma-3-1b-it-GGUF|gemma-3-1b-it-Q4_K_M.gguf">ğŸ’ Gemma 3 1B Q4 â€” ~700MB</option>
          <option value="bartowski/SmolLM2-1.7B-Instruct-GGUF|SmolLM2-1.7B-Instruct-Q4_K_M.gguf">ğŸ£ SmolLM2 1.7B Q4 â€” ~1GB</option>
        </select>
        <div id="wasmStatus" style="font-size:11px;color:var(--t3);margin-top:6px;text-align:center;">Aguardando...</div>
      </div>
    </div>

    <div id="localInfo" class="info-card">
      âœ… <strong>Modo Local Ativo</strong><br/>
      IA roda 100% no seu dispositivo.<br/>
      Sem API, sem custo, sem censura.
    </div>

    <div id="geminiSection" style="display:none">
      <div class="warn-card">
        â˜ï¸ <strong>Modo Gemini API</strong><br/>
        Requer chave gratuita do Google AI Studio.
      </div>
      <div class="kcard">
        <label>ğŸ”‘ Gemini API Key</label>
        <input class="kinp" type="password" id="kInp" placeholder="AIzaSy..."/>
        <label style="display:block;margin-top:8px;font-size:11px;color:var(--t3)">ğŸ¤– Modelo</label>
        <select class="msel" id="msel">
          <option value="gemini-2.0-flash-lite">âš¡ Gemini 2.0 Flash Lite (rÃ¡pido)</option>
          <option value="gemini-2.0-flash" selected>âœ¨ Gemini 2.0 Flash (recomendado)</option>
          <option value="gemini-1.5-flash">ğŸ”¥ Gemini 1.5 Flash</option>
          <option value="gemini-1.5-pro">ğŸ’ Gemini 1.5 Pro</option>
          <option value="gemini-2.5-flash-preview-04-17">ğŸš€ Gemini 2.5 Flash Preview</option>
        </select>
        <button class="ksave" onclick="saveKey()">âœ“ Salvar e Conectar</button>
        <div id="kst" style="font-size:11px;color:var(--t3);margin-top:6px;text-align:center;"></div>
      </div>
    </div>

    <div id="localModelSection">
      <div class="kcard">
        <label>ğŸ¤– Modelo Local</label>
        <select class="msel" id="localMsel" onchange="changeLocalModel()">
          <option value="SmolLM2-360M-Instruct-q4f32_1-MLC">ğŸ”¬ SmolLM2 360M q4f32 â€” 580MB Â· celular fraco</option>
          <option value="SmolLM2-1.7B-Instruct-q4f32_1-MLC">ğŸ£ SmolLM2 1.7B q4f32 â€” 2.7GB Â· celular mÃ©dio</option>
          <option value="TinyLlama-1.1B-Chat-v1.0-q4f32_1-MLC">ğŸ¦™ TinyLlama 1.1B q4f32 â€” 840MB Â· celular</option>
          <option value="Qwen2.5-Coder-0.5B-Instruct-q4f32_1-MLC">âš¡ Qwen Coder 0.5B q4f32 â€” 1GB Â· mÃ­nimo</option>
          <option value="Qwen2.5-Coder-1.5B-Instruct-q4f32_1-MLC">ğŸ’» Qwen Coder 1.5B q4f32 â€” 1.9GB Â· melhor custo</option>
          <option value="Qwen2.5-Coder-3B-Instruct-q4f32_1-MLC">ğŸ”¥ Qwen Coder 3B q4f32 â€” 2.9GB Â· celular potente</option>
          <option value="Llama-3.2-1B-Instruct-q4f32_1-MLC">ğŸ¦™ Llama 3.2 1B q4f32 â€” 1.1GB</option>
          <option value="Llama-3.2-3B-Instruct-q4f32_1-MLC">ğŸ¦™ Llama 3.2 3B q4f32 â€” 3GB</option>
          <option value="Qwen2.5-Coder-7B-Instruct-q4f32_1-MLC">ğŸš€ Qwen Coder 7B q4f32 â€” 5.9GB Â· PC</option>
        </select>
        <div id="localStatus" style="font-size:11px;color:var(--t3);margin-top:6px;text-align:center;">Carregando...</div>
      </div>
    </div>
  </div>

  <div class="dsec">
    <div class="dlbl">ğŸ› ï¸ Ferramentas de IA</div>
    <div class="tlist">
      <button class="titem on" data-t="build"    onclick="pTool(this)"><span class="ic">ğŸš€</span>Criar do Zero</button>
      <button class="titem"    data-t="fix"      onclick="pTool(this)"><span class="ic">ğŸ”§</span>Corrigir Bugs</button>
      <button class="titem"    data-t="analyze"  onclick="pTool(this)"><span class="ic">ğŸ”</span>Analisar CÃ³digo</button>
      <button class="titem"    data-t="refactor" onclick="pTool(this)"><span class="ic">âœ¨</span>Refatorar</button>
      <button class="titem"    data-t="explain"  onclick="pTool(this)"><span class="ic">ğŸ“–</span>Explicar CÃ³digo</button>
      <button class="titem"    data-t="complete" onclick="pTool(this)"><span class="ic">âš¡</span>Auto-Completar</button>
      <button class="titem"    data-t="convert"  onclick="pTool(this)"><span class="ic">ğŸ”„</span>Converter</button>
      <button class="titem"    data-t="docs"     onclick="pTool(this)"><span class="ic">ğŸ“</span>Gerar Docs</button>
      <button class="titem"    data-t="test"     onclick="pTool(this)"><span class="ic">ğŸ§ª</span>Gerar Testes</button>
      <button class="titem"    data-t="security" onclick="pTool(this)"><span class="ic">ğŸ”’</span>Auditoria Seg.</button>
      <button class="titem"    data-t="perf"     onclick="pTool(this)"><span class="ic">ğŸ“ˆ</span>Performance</button>
      <button class="titem"    data-t="css"      onclick="pTool(this)"><span class="ic">ğŸ¨</span>Melhorar CSS/Design</button>
      <button class="titem"    data-t="mobile"   onclick="pTool(this)"><span class="ic">ğŸ“±</span>Tornar Responsivo</button>
      <button class="titem"    data-t="chat"     onclick="pTool(this)"><span class="ic">ğŸ’¬</span>Chat Livre</button>
    </div>
  </div>

  <div class="dsec">
    <div class="dlbl">ğŸ“‚ Arquivos</div>
    <div class="upzone" onclick="document.getElementById('fi').click()">
      <div style="font-size:22px">ğŸ“‚</div>
      <p><strong style="color:var(--acl)">Toque para enviar</strong></p>
      <p>HTML, CSS, JS, TS, Python, PHP...</p>
    </div>
    <input type="file" id="fi" multiple accept=".html,.css,.js,.ts,.jsx,.tsx,.py,.php,.json,.md,.txt,.vue,.svelte" onchange="onFS(this)"/>
    <div id="flist"></div>
  </div>
  <div style="height:24px"></div>
</aside>

<!-- HEADER -->
<header class="hdr">
  <button class="ham" onclick="dOpen()">â˜°</button>
  <div class="logo">
    <div class="lmark">CM</div>
    <span class="lname">Code<em>Mind</em></span>
    <span class="lbadge">LOCAL</span>
  </div>
  <div class="hright">
    <div class="pill" onclick="dOpen()">
      <div class="sdot loading" id="sdot"></div>
      <span id="slbl">Carregando IA...</span>
    </div>
  </div>
</header>

<!-- TABS -->
<div class="tabs">
  <button class="tab on" id="t1" onclick="goTab('c')">ğŸ’¬ Chat IA</button>
  <button class="tab"    id="t2" onclick="goTab('e')">âŒ¨ï¸ Editor + Preview</button>
</div>

<div class="views">
  <!-- CHAT VIEW -->
  <div id="vC">
    <div class="msgs" id="msgs"></div>
    <div class="bot">
      <div class="sugs">
        <div class="sg" onclick="qs('Crie uma landing page profissional e moderna com hero animado, features, depoimentos e CTA')">ğŸŒ Landing Page</div>
        <div class="sg" onclick="qs('Crie um dashboard admin completo com sidebar, cards de mÃ©tricas, grÃ¡ficos e tabela de dados')">ğŸ“Š Dashboard</div>
        <div class="sg" onclick="qs('Crie um app to-do list com dark mode, localStorage e animaÃ§Ãµes bonitas')">âœ… To-Do App</div>
        <div class="sg" onclick="qs('Crie um portfÃ³lio de desenvolvedor moderno e responsivo')">ğŸ‘¤ PortfÃ³lio</div>
        <div class="sg" onclick="qs('Crie um e-commerce com vitrine de produtos, filtros e carrinho')">ğŸ›’ E-commerce</div>
        <div class="sg" onclick="qs('Crie um sistema de login e cadastro com validaÃ§Ã£o e animaÃ§Ãµes')">ğŸ” Login</div>
        <div class="sg" onclick="qs('Crie um quiz game interativo com timer e placar')">ğŸ¯ Quiz Game</div>
        <div class="sg" onclick="qs('Crie um chat app com bolhas de mensagem e design moderno')">ğŸ’¬ Chat App</div>
        <div class="sg" onclick="qs('Crie uma calculadora cientÃ­fica com design dark profissional')">ğŸ§® Calculadora</div>
        <div class="sg" onclick="qs('Corrija todos os erros no cÃ³digo do editor')">ğŸ”§ Corrigir</div>
        <div class="sg" onclick="qs('Analise o cÃ³digo e dÃª sugestÃµes detalhadas de melhoria')">ğŸ” Analisar</div>
        <div class="sg" onclick="qs('Torne o cÃ³digo do editor 100% responsivo para celular')">ğŸ“± Responsivo</div>
      </div>
      <div class="mbar" id="mbar">
        <button class="mc on" data-m="build">ğŸš€ Criar</button>
        <button class="mc" data-m="fix">ğŸ”§ Corrigir</button>
        <button class="mc" data-m="analyze">ğŸ” Analisar</button>
        <button class="mc" data-m="refactor">âœ¨ Refatorar</button>
        <button class="mc" data-m="explain">ğŸ“– Explicar</button>
        <button class="mc" data-m="complete">âš¡ Completar</button>
        <button class="mc" data-m="css">ğŸ¨ Design</button>
        <button class="mc" data-m="mobile">ğŸ“± Responsivo</button>
        <button class="mc" data-m="test">ğŸ§ª Testes</button>
        <button class="mc" data-m="security">ğŸ”’ SeguranÃ§a</button>
        <button class="mc" data-m="chat">ğŸ’¬ Chat</button>
      </div>
      <div class="irow">
        <textarea id="inp" rows="1" placeholder="Descreva o site ou app que quer criar..." onkeydown="onK(event)" oninput="ar(this)"></textarea>
        <button class="sbtn" id="sbtn" onclick="send()">
          <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
        </button>
      </div>
      <div class="ipad"></div>
    </div>
  </div>

  <!-- EDITOR VIEW -->
  <div id="vE">
    <div class="etb">
      <button class="eb p" onclick="runPrev()">â–¶ Executar</button>
      <button class="eb" onclick="cpCode()">ğŸ“‹ Copiar</button>
      <button class="eb" onclick="dlCode()">ğŸ’¾ Download</button>
      <button class="eb" onclick="newTab()">â†— Nova Aba</button>
      <button class="eb" onclick="clearEd()" style="color:var(--rd)">ğŸ—‘ï¸</button>
    </div>
    <div class="epanes">
      <div class="cpane">
        <div class="pbar">
          <div class="pdots">
            <div class="pd" style="background:#ff5f57"></div>
            <div class="pd" style="background:#febc2e"></div>
            <div class="pd" style="background:#28c840"></div>
          </div>
          <span id="cfn">output.html</span>
          <span id="cln">0 linhas</span>
        </div>
        <textarea id="ca" spellcheck="false"
          placeholder="// CÃ³digo gerado pelo CodeMind AI...&#10;// Use o Chat para gerar, ou cole aqui e clique â–¶ Executar"
          oninput="onCh()"></textarea>
      </div>
      <div class="ppane">
        <div class="pbar">
          <span>ğŸŒ Preview ao Vivo</span>
          <span id="pst" style="color:var(--t3)">â€”</span>
        </div>
        <iframe id="pf" sandbox="allow-scripts allow-same-origin allow-forms allow-modals allow-popups" src="about:blank"></iframe>
      </div>
    </div>
  </div>
</div>

<script type="module">
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// IMPORTS - WebLLM Engine (WebGPU)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
import * as webllm from "https://esm.run/@mlc-ai/web-llm";

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let KEY    = localStorage.getItem('cm_k') || '';
let MDL    = localStorage.getItem('cm_m') || 'gemini-2.0-flash';
// Auto-detect mobile â†’ default to WASM engine on mobile
const isMobile = /Android|iPhone|iPad/i.test(navigator.userAgent);
let ENGINE = localStorage.getItem('cm_engine') || (isMobile ? 'wasm' : 'local');
let LMDL   = localStorage.getItem('cm_lm') || 'Qwen2.5-Coder-1.5B-Instruct-q4f32_1-MLC';
// WASM model: HuggingFace repo + filename
let WMDL   = localStorage.getItem('cm_wm') || 'Qwen/Qwen2.5-0.5B-Instruct-GGUF|qwen2.5-0.5b-instruct-q4_k_m.gguf';
let MODE   = 'build';
let FILES  = [];
let BUSY   = false;
let LAST   = '';
let localEngine  = null;  // WebLLM engine
let wasmEngine   = null;  // wllama engine
let engineReady  = false;
let healCount    = 0;
const MAX_HEALS  = 3;

// Expose globals
window.goTab = goTab;
window.dOpen = dOpen;
window.dClose = dClose;
window.send = send;
window.qs = qs;
window.saveKey = saveKey;
window.pTool = pTool;
window.setEngine = setEngine;
window.changeLocalModel = changeLocalModel;
window.changeWasmModel = changeWasmModel;
window.skipToGemini = skipToGemini;
window.retryLocalEngine = retryLocalEngine;
window.runPrev = runPrev;
window.cpCode = cpCode;
window.dlCode = dlCode;
window.newTab = newTab;
window.clearEd = clearEd;
window.onCh = onCh;
window.onFS = onFS;
window.ar = ar;
window.onK = onK;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BOOT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(async function boot() {
  if(KEY) document.getElementById('kInp').value = KEY;
  document.getElementById('msel').value = MDL;
  document.getElementById('localMsel').value = LMDL;
  document.getElementById('wasmMsel').value = WMDL;
  document.querySelectorAll('.mc').forEach(c => c.onclick = () => setMode(c.dataset.m));

  applyEngineUI(ENGINE);

  if(ENGINE === 'local') {
    await initLocalEngine();
  } else if(ENGINE === 'wasm') {
    await initWasmEngine();
  } else {
    hideOverlay();
    if(KEY) setStatus('on', 'â— Gemini Conectado');
    else setStatus('', 'Configurar API');
  }

  addMsg('ai',
    'ğŸ‘‹ OlÃ¡! Sou o **CodeMind AI**.\n\n' +
    (ENGINE === 'wasm'
      ? 'ğŸ§© IA rodando via **WebAssembly** (CPU) â€” funciona em qualquer celular!\n\n'
      : ENGINE === 'local'
      ? 'ğŸ§  IA rodando **100% local** via WebGPU â€” sem API, sem custo.\n\n'
      : '') +
    'Crie **sites e apps profissionais** do zero, corrija bugs e otimize cÃ³digo!'
  );
})();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LOCAL ENGINE (WebLLM / WebGPU)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function initLocalEngine() {
  showOverlay('loading');
  setStatus('loading', 'Verificando hardware...');

  // â”€â”€ Passo 1: testar WebGPU â”€â”€
  let gpuOk = false;
  if(navigator.gpu) {
    try { gpuOk = !!(await navigator.gpu.requestAdapter()); } catch(_){}
  }

  if(!gpuOk) {
    showOverlay('error');
    setStatus('err', 'WebGPU indisponÃ­vel');
    return; // Fica na tela de erro. UsuÃ¡rio lÃª as instruÃ§Ãµes e age.
  }

  // â”€â”€ Passo 2: carregar modelo â”€â”€
  showOverlay('loading');
  try {
    localEngine = await webllm.CreateMLCEngine(LMDL, {
      initProgressCallback: (prog) => {
        const pct = Math.round((prog.progress || 0) * 100);
        document.getElementById('olBar').style.width = pct + '%';
        document.getElementById('olStatus').textContent = prog.text || `Carregando... ${pct}%`;
      }
    });
    engineReady = true;
    hideOverlay();
    setStatus('on', 'ğŸ§  IA Local Online');
    document.getElementById('localStatus').textContent = 'âœ… Modelo carregado!';
    setupAutoHealing();
    toast('âœ… IA Local pronta! Rodando na sua GPU.', 'ok');
  } catch(e) {
    console.error('WebLLM error:', e);
    const isOOM = /memory|oom|buffer/i.test(e.message);
    showOverlay('error', e.message);
    setStatus('err', 'Erro no modelo');
    document.getElementById('localStatus').textContent = 'âŒ ' + e.message;
  }
}

function showOverlay(mode, extraMsg) {
  const ov = document.getElementById('aiOverlay');
  ov.classList.remove('hidden');

  if(mode === 'error') {
    // Diagnose specific error types
    const isWorkgroup = extraMsg && extraMsg.includes('WorkgroupStorage');
    const isOOM = extraMsg && /memory|oom|buffer/i.test(extraMsg);

    let title = 'Erro ao Carregar IA';
    let instructions = '';

    if(isWorkgroup) {
      title = 'GPU IncompatÃ­vel com este Modelo';
      instructions = `
        <br/><br/>
        <strong style="color:#fbbf24">âœ… SoluÃ§Ã£o:</strong> Troque para um modelo menor.<br/>
        Clique em <strong>â˜° Trocar Modelo</strong> e escolha:<br/><br/>
        <strong style="color:#a78bfa">ğŸ”¬ SmolLM2 360M q4f32</strong> â€” 580MB, mÃ­nimo absoluto<br/>
        <strong style="color:#a78bfa">ğŸ¦™ TinyLlama 1.1B q4f32</strong> â€” 840MB<br/>
        <strong style="color:#a78bfa">âš¡ Qwen Coder 0.5B q4f32</strong> â€” 1GB<br/><br/>
        Todos os modelos <strong>q4f32</strong> sÃ£o compatÃ­veis com GPUs de limite 16384.`;
    } else if(isOOM) {
      title = 'MemÃ³ria Insuficiente';
      instructions = `<br/><br/>Troque para um modelo menor no menu <strong>â˜°</strong> â†’ Motor Local.`;
    } else {
      instructions = `
        <br/><br/>
        <strong style="color:#a78bfa">Como ativar WebGPU no Chrome Android:</strong><br/>
        1. Abra <code>chrome://flags</code><br/>
        2. Busque <strong>WebGPU</strong><br/>
        3. Ative <strong>"Unsafe WebGPU"</strong><br/>
        4. Reinicie o Chrome<br/><br/>
        <strong>No PC:</strong> Use Chrome 113+ ou Edge 113+`;
    }

    document.getElementById('olIcon').textContent = 'âš ï¸';
    document.getElementById('olTitle').innerHTML = title;
    document.getElementById('olSub').innerHTML =
      `<code style="font-size:11px;opacity:.7">${extraMsg || 'WebGPU indisponÃ­vel'}</code>` + instructions;
    document.getElementById('olBar').style.width = '0%';
    document.getElementById('olBar').style.background = 'var(--rd)';
    document.getElementById('olStatus').textContent = 'âŒ Carregamento falhou';
    document.getElementById('olRetryBtn').style.display = 'block';
    document.getElementById('olSkipBtn').style.display = 'block';
    document.getElementById('olSkipBtn').textContent = 'â˜° Trocar Modelo';
  } else {
    document.getElementById('olIcon').textContent = 'ğŸ§ ';
    document.getElementById('olTitle').innerHTML = 'Code<em>Mind</em> AI';
    document.getElementById('olSub').textContent = 'Carregando o motor de IA local... Isso leva ~30s na primeira vez. O modelo fica no cache depois.';
    document.getElementById('olBar').style.background = 'linear-gradient(90deg,var(--ac),var(--cy))';
    document.getElementById('olStatus').textContent = 'Iniciando WebGPU...';
    document.getElementById('olRetryBtn').style.display = 'none';
    document.getElementById('olSkipBtn').style.display = 'block';
  }
}
function hideOverlay() { document.getElementById('aiOverlay').classList.add('hidden'); }
function skipToGemini() { hideOverlay(); dOpen(); }
async function retryLocalEngine() { await initLocalEngine(); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WASM ENGINE (wllama - llama.cpp in browser)
// Works on ANY device - no WebGPU needed
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function initWasmEngine() {
  showOverlay('loading');
  document.getElementById('olStatus').textContent = 'Carregando motor WASM (CPU)...';
  document.getElementById('olSub').innerHTML =
    'ğŸ§© Modo WebAssembly: funciona em <strong>qualquer celular</strong>.<br/>NÃ£o precisa de WebGPU. Mais lento, mas universal.';

  try {
    const { Wllama } = await import('https://esm.run/@wllama/wllama');

    const CONFIG_PATHS = {
      'single-thread/wllama.wasm': 'https://cdn.jsdelivr.net/npm/@wllama/wllama/esm/single-thread/wllama.wasm',
      'multi-thread/wllama.wasm':  'https://cdn.jsdelivr.net/npm/@wllama/wllama/esm/multi-thread/wllama.wasm',
    };

    wasmEngine = new Wllama(CONFIG_PATHS, { n_threads: 1 });

    const [repo, file] = WMDL.split('|');
    document.getElementById('olStatus').textContent = `Baixando modelo: ${file}...`;

    await wasmEngine.loadModelFromHF(repo, file, {
      progressCallback: ({ loaded, total }) => {
        const pct = total ? Math.round((loaded / total) * 100) : 0;
        document.getElementById('olBar').style.width = pct + '%';
        document.getElementById('olStatus').textContent = `Baixando modelo... ${pct}%`;
      }
    });

    engineReady = true;
    hideOverlay();
    setStatus('on', 'ğŸ§© WASM Online');
    document.getElementById('wasmStatus').textContent = 'âœ… Modelo carregado!';
    setupAutoHealing();
    toast('âœ… IA WASM pronta! Roda em qualquer celular.', 'ok');

  } catch(e) {
    console.error('wllama error:', e);
    showOverlay('error', 'Erro WASM: ' + e.message);
    setStatus('err', 'Erro WASM');
    document.getElementById('wasmStatus').textContent = 'âŒ ' + e.message;
  }
}

async function callWasmAI(prompt) {
  const aiMsgEl = addStreamMsg();
  const systemPart = 'VocÃª Ã© CodeMind AI, desenvolvedor web senior. Siga as instruÃ§Ãµes precisamente.\n\n';
  const fullPrompt = `<|im_start|>system\n${systemPart}<|im_end|>\n<|im_start|>user\n${prompt}<|im_end|>\n<|im_start|>assistant\n`;

  let full = '';
  await wasmEngine.createCompletion(fullPrompt, {
    nPredict: 2048,
    temperature: 0.3,
    onNewToken: (token, piece, text) => {
      full += piece;
      updateStreamMsg(aiMsgEl, full);
    }
  });

  finalizeStreamMsg(aiMsgEl, full);
  return full;
}

async function changeWasmModel() {
  WMDL = document.getElementById('wasmMsel').value;
  localStorage.setItem('cm_wm', WMDL);
  engineReady = false;
  wasmEngine = null;
  document.getElementById('wasmStatus').textContent = 'Recarregando...';
  await initWasmEngine();
}

async function changeLocalModel() {
  LMDL = document.getElementById('localMsel').value;
  localStorage.setItem('cm_lm', LMDL);
  engineReady = false;
  localEngine = null;
  document.getElementById('localStatus').textContent = 'Recarregando...';
  await initLocalEngine();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTO-HEALING SYSTEM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setupAutoHealing() {
  window.addEventListener('message', async (e) => {
    if(e.data?.type !== 'cm_error') return;
    if(BUSY || healCount >= MAX_HEALS) return;

    healCount++;
    const badge = document.getElementById('healBadge');
    badge.classList.add('show');
    badge.textContent = `ğŸ”§ Auto-Heal #${healCount} ativado!`;
    setTimeout(() => badge.classList.remove('show'), 3000);

    const errMsg = e.data.msg;
    const code = document.getElementById('ca').value;
    const fixPrompt = `ERRO DETECTADO NO RUNTIME:\n"${errMsg}"\n\nCORREÃ‡ÃƒO AUTOMÃTICA NECESSÃRIA. Analise o cÃ³digo abaixo e corrija o erro especÃ­fico. Mantenha todas as funcionalidades. Retorne HTML completo funcional.\n\nCÃ“DIGO:\n${code}`;

    document.getElementById('inp').value = fixPrompt;
    await send(true); // silent = true, sem resetar healCount
  });
}

function injectHealScript(html) {
  const script = `<script>
    window.onerror = function(msg, src, line, col, err) {
      window.parent.postMessage({type:'cm_error', msg: msg + ' [linha ' + line + ']'}, '*');
      return true;
    };
    window.addEventListener('unhandledrejection', function(e) {
      window.parent.postMessage({type:'cm_error', msg: 'Promise rejeitada: ' + e.reason}, '*');
    });
  <\/script>`;
  return html.includes('<head>') ? html.replace('<head>', '<head>' + script) : script + html;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ENGINE TOGGLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setEngine(e) {
  ENGINE = e;
  localStorage.setItem('cm_engine', e);
  applyEngineUI(e);
  if(e === 'local' && !engineReady && !localEngine) initLocalEngine();
  else if(e === 'wasm' && !engineReady && !wasmEngine) initWasmEngine();
  else if(e === 'gemini') {
    if(KEY) setStatus('on', 'â— Gemini Conectado');
    else setStatus('', 'Configurar API');
  }
}

function applyEngineUI(e) {
  document.getElementById('engLocal').classList.toggle('on', e === 'local');
  document.getElementById('engWasm').classList.toggle('on', e === 'wasm');
  document.getElementById('engGemini').classList.toggle('on', e === 'gemini');
  document.getElementById('localInfo').style.display = e === 'local' ? '' : 'none';
  document.getElementById('wasmSection').style.display = e === 'wasm' ? '' : 'none';
  document.getElementById('geminiSection').style.display = e === 'gemini' ? '' : 'none';
  document.getElementById('localModelSection').style.display = e === 'local' ? '' : 'none';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MAIN SEND
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function send(silent = false) {
  const el = document.getElementById('inp');
  const txt = el.value.trim();
  if(!txt || BUSY) return;

  if(ENGINE === 'gemini' && !KEY) return toast('âš ï¸ Configure sua API Key no menu â˜°', 'err');
  if(ENGINE !== 'gemini' && !engineReady) return toast('â³ IA ainda carregando... aguarde.', 'err');

  el.value = ''; ar(el);
  if(!silent) addMsg('user', txt);
  setBusy(true);

  const code = document.getElementById('ca').value;
  const fctx = FILES.length ? '\n\nARQUIVOS:\n' + FILES.map(f => `=== ${f.name} ===\n${f.content}`).join('\n\n') : '';

  const P = buildPrompts(txt, code, fctx);
  const prompt = P[MODE] || P.chat;

  const tid = addTyping();
  try {
    let res;
    if(ENGINE === 'local') {
      res = await callLocalAI(prompt, tid);
    } else if(ENGINE === 'wasm') {
      delEl(tid);
      res = await callWasmAI(prompt);
    } else {
      res = await callGemini(prompt);
    }
    delEl(tid); setBusy(false);

    const isCode = ['build','fix','refactor','complete','convert','css','mobile','perf'].includes(MODE);
    let out = res;
    if(isCode) {
      const m = res.match(/<!DOCTYPE\s+html[\s\S]*/i);
      if(m) out = m[0].replace(/\n?```\s*$/, '').trim();
    }

    if(!silent) healCount = 0; // Reset heal counter on manual send

    if(isCode && out.match(/^<!DOCTYPE\s+html/i)) {
      LAST = out;
      setCode(out); runPrev();
      addMsg('ai', 'âœ… **Pronto!** CÃ³digo gerado com sucesso!\n\nAbra **Editor + Preview** para ver ao vivo. Pode pedir ajustes!');
      addCodeBtns();
    } else {
      addMsg('ai', res);
    }
  } catch(e) {
    delEl(tid); setBusy(false);
    addMsg('er', 'âŒ **Erro:** ' + e.message);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LOCAL AI CALL (streaming)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function callLocalAI(prompt, typingId) {
  delEl(typingId);
  const aiMsgEl = addStreamMsg();

  const chunks = await localEngine.chat.completions.create({
    messages: [
      { role: 'system', content: 'VocÃª Ã© CodeMind AI, um desenvolvedor web senior de elite. Siga as instruÃ§Ãµes precisamente.' },
      { role: 'user', content: prompt }
    ],
    temperature: 0.3,
    stream: true
  });

  let full = '';
  for await (const chunk of chunks) {
    const delta = chunk.choices[0]?.delta?.content || '';
    full += delta;
    updateStreamMsg(aiMsgEl, full);
  }
  finalizeStreamMsg(aiMsgEl, full);
  return full;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GEMINI API CALL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function callGemini(prompt) {
  const url = `https://generativelanguage.googleapis.com/v1beta/models/${MDL}:generateContent?key=${KEY}`;
  const r = await fetch(url, {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({
      contents: [{role:'user', parts:[{text:prompt}]}],
      generationConfig: { temperature:0.75, maxOutputTokens:8192, topP:0.9, topK:40 },
      safetySettings: [
        {category:'HARM_CATEGORY_HARASSMENT', threshold:'BLOCK_ONLY_HIGH'},
        {category:'HARM_CATEGORY_HATE_SPEECH', threshold:'BLOCK_ONLY_HIGH'},
        {category:'HARM_CATEGORY_SEXUALLY_EXPLICIT', threshold:'BLOCK_MEDIUM_AND_ABOVE'},
        {category:'HARM_CATEGORY_DANGEROUS_CONTENT', threshold:'BLOCK_ONLY_HIGH'},
      ]
    })
  });
  if(!r.ok){ const e = await r.json().catch(()=>null); throw new Error(e?.error?.message || `HTTP ${r.status}`); }
  const d = await r.json();
  const t = d?.candidates?.[0]?.content?.parts?.[0]?.text;
  if(!t) throw new Error('Resposta vazia â€” tente novamente');
  return t.replace(/^```html\n?/i,'').replace(/\n?```$/,'').trim();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PROMPTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildPrompts(txt, code, fctx) {
  return {
    build:`VocÃª Ã© CodeMind AI, desenvolvedor web senior de elite. MissÃ£o: criar interfaces profissionais.
REGRAS: OUTPUT SOMENTE cÃ³digo HTML. InÃ­cio EXATO: <!DOCTYPE html>. ZERO texto/markdown fora do HTML.
CSS em <style> no <head>. JS em <script> no fim do <body>. Google Fonts com @import.
Dark theme, responsivo mobile-first, animaÃ§Ãµes suaves, imagens: https://picsum.photos/[w]/[h]?random=[n]
Qualidade nÃ­vel Stripe/Linear/Vercel.
PROJETO: ${txt}${fctx}`,

    fix:`VocÃª Ã© CodeMind AI, especialista em debugging.
Analise e corrija TODOS os erros. OUTPUT: SOMENTE HTML corrigido comeÃ§ando com <!DOCTYPE html>
Adicione comentÃ¡rios <!-- FIX: descriÃ§Ã£o --> em cada ponto corrigido.
CÃ“DIGO: ${code||'(vazio â€” cole o cÃ³digo)'}
PROBLEMA: ${txt}${fctx}`,

    analyze:`VocÃª Ã© CodeMind AI, senior code reviewer. AnÃ¡lise COMPLETA em portuguÃªs:
## ğŸ“Š Nota: X/10
## ğŸ› Bugs (localizaÃ§Ã£o e soluÃ§Ã£o)
## âš¡ Performance
## ğŸ”’ SeguranÃ§a
## âœ… Pontos Positivos
## ğŸ’¡ Top 5 Melhorias
CÃ“DIGO: ${code||'(vazio)'}
${txt}${fctx}`,

    refactor:`VocÃª Ã© CodeMind AI, clean code specialist. Refatore mantendo funcionalidade.
OUTPUT: SOMENTE HTML refatorado comeÃ§ando com <!DOCTYPE html>
CÃ“DIGO: ${code||'(vazio)'}
INSTRUÃ‡Ã•ES: ${txt}${fctx}`,

    explain:`VocÃª Ã© CodeMind AI, professor senior. Explique em portuguÃªs: o que faz, como funciona, tÃ©cnicas usadas, o que pode melhorar.
CÃ“DIGO: ${code||'(vazio)'}
${txt}${fctx}`,

    complete:`VocÃª Ã© CodeMind AI. Complete de forma profissional e coerente com o estilo existente.
OUTPUT: HTML COMPLETO comeÃ§ando com <!DOCTYPE html>
CÃ“DIGO INCOMPLETO: ${code}
OBJETIVO: ${txt}${fctx}`,

    convert:`VocÃª Ã© CodeMind AI. Converta mantendo toda a funcionalidade.
Se HTML: comece com <!DOCTYPE html>
CÃ“DIGO: ${code}
PEDIDO: ${txt}${fctx}`,

    docs:`VocÃª Ã© CodeMind AI, technical writer. DocumentaÃ§Ã£o completa em portuguÃªs.
CÃ“DIGO: ${code}
${txt}${fctx}`,

    test:`VocÃª Ã© CodeMind AI, QA engineer. Gere testes completos: unitÃ¡rios, integraÃ§Ã£o, edge cases.
CÃ“DIGO: ${code}
${txt}${fctx}`,

    security:`VocÃª Ã© CodeMind AI, seguranÃ§a web expert. Auditoria: XSS, injeÃ§Ã£o, CSRF, dados sensÃ­veis.
Para cada item: risco, cÃ³digo problemÃ¡tico, correÃ§Ã£o.
CÃ“DIGO: ${code}
${txt}${fctx}`,

    perf:`VocÃª Ã© CodeMind AI, performance expert. Analise e otimize gargalos, Core Web Vitals.
Se possÃ­vel retorne cÃ³digo otimizado comeÃ§ando com <!DOCTYPE html>
CÃ“DIGO: ${code}
${txt}${fctx}`,

    css:`VocÃª Ã© CodeMind AI, UI/UX designer. Melhore design: cores, tipografia, animaÃ§Ãµes, visual profissional.
OUTPUT: SOMENTE HTML com CSS melhorado comeÃ§ando com <!DOCTYPE html>
CÃ“DIGO: ${code||'(vazio)'}
MELHORIAS: ${txt}${fctx}`,

    mobile:`VocÃª Ã© CodeMind AI, mobile-first specialist. Torne 100% responsivo e perfeito no celular.
OUTPUT: SOMENTE HTML responsivo comeÃ§ando com <!DOCTYPE html>
CÃ“DIGO: ${code||'(vazio)'}
${txt}${fctx}`,

    chat:`VocÃª Ã© CodeMind AI, senior dev assistant. Responda em portuguÃªs claro e tÃ©cnico.
${txt}${code ? `\nCÃ“DIGO:\n${code}` : ''}${fctx}`,
  };
}

// CHAT UI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function addMsg(type, text){
  const log = document.getElementById('msgs');
  const d = document.createElement('div');
  if(type === 'sc' || type === 'er'){
    d.className = 'msg ' + type;
    d.innerHTML = `<div class="bub">${md(text)}</div>`;
  } else {
    d.className = 'msg ' + type;
    d.innerHTML = `
      <div class="av">${type==='user'?'ğŸ‘¤':'ğŸ¤–'}</div>
      <div class="mw">
        <div class="mn">${type==='user'?'VocÃª':'CodeMind AI'}</div>
        <div class="bub">${md(text)}</div>
      </div>`;
  }
  log.appendChild(d); log.scrollTop = log.scrollHeight;
  return d;
}

function addStreamMsg() {
  const log = document.getElementById('msgs');
  const d = document.createElement('div');
  d.className = 'msg ai';
  const id = 'sm_' + Date.now();
  d.innerHTML = `
    <div class="av">ğŸ¤–</div>
    <div class="mw">
      <div class="mn">CodeMind AI <span style="font-size:9px;color:var(--ac);font-weight:400;">â— streaming</span></div>
      <div class="bub" id="${id}"><span class="streaming"></span></div>
    </div>`;
  log.appendChild(d); log.scrollTop = log.scrollHeight;
  d._bubId = id;
  return d;
}

function updateStreamMsg(el, text) {
  const bub = document.getElementById(el._bubId);
  if(bub) { bub.innerHTML = md(text) + '<span class="streaming"></span>'; }
  const log = document.getElementById('msgs');
  log.scrollTop = log.scrollHeight;
}

function finalizeStreamMsg(el, text) {
  const bub = document.getElementById(el._bubId);
  if(bub) bub.innerHTML = md(text);
  // Remove streaming label
  const mn = el.querySelector('.mn');
  if(mn) mn.innerHTML = 'CodeMind AI';
}

function addCodeBtns(){
  const log = document.getElementById('msgs');
  const d = document.createElement('div');
  d.className = 'msg ai';
  d.innerHTML = `
    <div class="av">ğŸ¤–</div>
    <div class="mw"><div class="mn">CodeMind AI</div>
    <div class="bub"><div class="cbts">
      <button class="cb p" onclick="goTab('e')">âŒ¨ï¸ Ver no Editor</button>
      <button class="cb" onclick="cpCode()">ğŸ“‹ Copiar</button>
      <button class="cb" onclick="dlCode()">ğŸ’¾ Download</button>
      <button class="cb" onclick="newTab()">â†— Nova Aba</button>
    </div></div></div>`;
  log.appendChild(d); log.scrollTop = log.scrollHeight;
}

function addTyping(){
  const log = document.getElementById('msgs');
  const d = document.createElement('div');
  const id = 'tp'+Date.now(); d.id = id;
  d.className = 'msg ai';
  d.innerHTML = `<div class="av">ğŸ¤–</div><div class="mw"><div class="mn">CodeMind AI</div><div class="bub"><div class="typing"><span></span><span></span><span></span></div></div></div>`;
  log.appendChild(d); log.scrollTop = log.scrollHeight;
  return id;
}
function delEl(id){ document.getElementById(id)?.remove(); }

function md(t){
  return (t||'')
    .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
    .replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>')
    .replace(/\*(.+?)\*/g,'<em>$1</em>')
    .replace(/`([^`\n]+)`/g,'<code style="background:rgba(255,255,255,.08);padding:1px 5px;border-radius:4px;font-family:\'JetBrains Mono\',monospace;font-size:.88em">$1</code>')
    .replace(/^## (.+)/gm,'<strong style="display:block;margin:10px 0 4px;color:#a78bfa;font-size:13px">$1</strong>')
    .replace(/^â€¢ (.+)/gm,'<span style="display:block;padding-left:10px">â€¢ $1</span>')
    .replace(/\n/g,'<br>');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EDITOR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setCode(c){ document.getElementById('ca').value = c; onCh(); }
function onCh(){
  const v = document.getElementById('ca').value;
  document.getElementById('cln').textContent = v.split('\n').length + ' linhas';
  LAST = v;
}
function runPrev(){
  const c = document.getElementById('ca').value;
  if(!c.trim()) return;
  const withHeal = injectHealScript(c);
  document.getElementById('pf').src = URL.createObjectURL(new Blob([withHeal],{type:'text/html'}));
  const ps = document.getElementById('pst');
  ps.textContent = 'âœ… Rodando'; ps.style.color = 'var(--gr)';
}
function cpCode(){
  const c = document.getElementById('ca').value || LAST;
  if(!c) return toast('Nada para copiar','err');
  if(navigator.clipboard) navigator.clipboard.writeText(c).then(()=>toast('Copiado!','ok'));
  else { const t=document.createElement('textarea');t.value=c;document.body.appendChild(t);t.select();document.execCommand('copy');document.body.removeChild(t);toast('Copiado!','ok'); }
}
function dlCode(){
  const c = document.getElementById('ca').value || LAST;
  if(!c) return toast('Nada para baixar','err');
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([c],{type:'text/html'}));
  a.download = 'codemind-output.html'; a.click();
  toast('Download iniciado!','ok');
}
function newTab(){
  const c = document.getElementById('ca').value || LAST;
  if(!c) return toast('Nada para abrir','err');
  window.open(URL.createObjectURL(new Blob([c],{type:'text/html'})),'_blank');
}
function clearEd(){
  if(!confirm('Limpar editor?')) return;
  document.getElementById('ca').value = '';
  document.getElementById('pf').src = 'about:blank';
  document.getElementById('pst').textContent = 'â€”';
  document.getElementById('pst').style.color = 'var(--t3)';
  LAST = ''; onCh();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FILES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function onFS(inp){ Array.from(inp.files).forEach(rf); inp.value=''; }
function rf(file){
  const r = new FileReader();
  r.onload = e => {
    FILES.push({name:file.name,content:e.target.result,size:file.size});
    renderF();
    const ext = file.name.split('.').pop().toLowerCase();
    if(['html','js','css','ts','jsx','tsx','py','php','vue','svelte'].includes(ext)){
      setCode(e.target.result); runPrev(); toast(file.name+' carregado!','ok');
    } else toast(file.name+' adicionado','ok');
  };
  r.readAsText(file);
}
function renderF(){
  document.getElementById('flist').innerHTML = FILES.map((f,i)=>`
    <div class="fchip">
      <span>ğŸ“„</span><span class="fn">${f.name}</span>
      <span style="color:var(--t3);font-size:10px">${(f.size/1024).toFixed(1)}kb</span>
      <span class="rm" onclick="FILES.splice(${i},1);renderF()">âœ•</span>
    </div>`).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setStatus(type, label) {
  const dot = document.getElementById('sdot');
  const lbl = document.getElementById('slbl');
  dot.className = 'sdot' + (type ? ' ' + type : '');
  lbl.textContent = label;
}
function setBusy(on){
  BUSY = on;
  document.getElementById('sbtn').disabled = on;
  const p = document.getElementById('prog');
  p.style.width = on ? '78%' : '100%';
  if(!on) setTimeout(()=>p.style.width='0', 350);
}
function toast(msg,type=''){
  const t = document.getElementById('toast');
  t.textContent=msg; t.className='show '+type;
  clearTimeout(t._t); t._t=setTimeout(()=>t.className='',2800);
}
function ar(el){ el.style.height='auto'; el.style.height=Math.min(el.scrollHeight,120)+'px'; }
function onK(e){ if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();send();} }
function qs(t){ document.getElementById('inp').value = t; send(); }

// DRAWER
function dOpen(){ document.getElementById('dr').classList.add('open'); document.getElementById('ov').classList.add('show'); }
function dClose(){ document.getElementById('dr').classList.remove('open'); document.getElementById('ov').classList.remove('show'); }

// TABS
function goTab(v){
  const e = v === 'e';
  document.getElementById('t1').classList.toggle('on', !e);
  document.getElementById('t2').classList.toggle('on', e);
  document.getElementById('vC').style.display = e ? 'none' : 'flex';
  document.getElementById('vE').style.display  = e ? 'flex' : 'none';
  if(e && LAST) runPrev();
}

// TOOLS
function pTool(el){
  document.querySelectorAll('.titem').forEach(b => b.classList.remove('on'));
  el.classList.add('on');
  setMode(el.dataset.t);
  dClose();
}
function setMode(m){
  MODE = m;
  document.querySelectorAll('.mc').forEach(c => c.classList.toggle('on', c.dataset.m === m));
  const ph = {
    build:'Descreva o site ou app que quer criar do zero...',
    fix:'Descreva o bug. O cÃ³digo deve estar no editor...',
    analyze:'PeÃ§a anÃ¡lise completa do cÃ³digo no editor...',
    refactor:'Instrua como melhorar e limpar o cÃ³digo...',
    explain:'PeÃ§a explicaÃ§Ã£o detalhada do cÃ³digo...',
    complete:'Descreva o que o cÃ³digo incompleto deve fazer...',
    convert:'Informe para qual linguagem converter...',
    docs:'PeÃ§a documentaÃ§Ã£o completa do cÃ³digo...',
    test:'PeÃ§a geraÃ§Ã£o de testes automatizados...',
    security:'PeÃ§a auditoria de seguranÃ§a do cÃ³digo...',
    perf:'PeÃ§a anÃ¡lise e otimizaÃ§Ã£o de performance...',
    css:'Descreva melhorias visuais/design que quer...',
    mobile:'Descreva como quer a versÃ£o mobile...',
    chat:'FaÃ§a qualquer pergunta de programaÃ§Ã£o...',
  };
  document.getElementById('inp').placeholder = ph[m] || 'Digite...';
}

// KEY SAVE
function saveKey(){
  const k = document.getElementById('kInp').value.trim();
  const m = document.getElementById('msel').value;
  if(!k){ document.getElementById('kst').textContent='âš ï¸ Insira uma API Key'; return; }
  KEY = k; MDL = m;
  localStorage.setItem('cm_k', k);
  localStorage.setItem('cm_m', m);
  setStatus('on', 'â— Gemini Conectado');
  toast('âœ… Conectado com ' + m, 'ok');
  dClose();
}
</script>
</body>
</html>
